#!/bin/bash
# ============================================================
#  Capture OS Pro - ä¸€é”®éƒ¨ç½²è„šæœ¬ (æ–°åŠ å¡ VPS ä¸“ç”¨)
#  
#  ä½¿ç”¨æ–¹æ³•ï¼š
#    chmod +x deploy.sh
#    sudo bash deploy.sh
#
#  å‰æï¼šUbuntu 20.04 / 22.04 / 24.04 (Debian ä¹Ÿå¯)
# ============================================================

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# ---------- é¢œè‰²è¾“å‡º ----------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info()  { echo -e "${BLUE}[INFO]${NC} $1"; }
ok()    { echo -e "${GREEN}[âœ…]${NC} $1"; }
warn()  { echo -e "${YELLOW}[âš ï¸]${NC} $1"; }
fail()  { echo -e "${RED}[âŒ]${NC} $1"; exit 1; }

# ---------- æ£€æŸ¥æƒé™ ----------
if [ "$EUID" -ne 0 ]; then
    fail "è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬ï¼šsudo bash deploy.sh"
fi

echo ""
echo "========================================================"
echo "  ğŸš€ Capture OS Pro - ä¸€é”®éƒ¨ç½²"
echo "  ğŸ“ ç›®æ ‡ï¼šæ–°åŠ å¡ VPS"
echo "========================================================"
echo ""

# ---------- ç”¨æˆ·è¾“å…¥ ----------
read -p "è¯·è¾“å…¥ä½ çš„åŸŸå (ä¾‹å¦‚ capture.example.com): " DOMAIN
if [ -z "$DOMAIN" ]; then
    fail "åŸŸåä¸èƒ½ä¸ºç©ºï¼"
fi

read -p "è¯·è¾“å…¥ä½ çš„é‚®ç®± (ç”¨äº SSL è¯ä¹¦é€šçŸ¥): " EMAIL
if [ -z "$EMAIL" ]; then
    warn "æœªè¾“å…¥é‚®ç®±ï¼ŒSSL è¯ä¹¦å°†ä½¿ç”¨ --register-unsafely-without-email"
    EMAIL_FLAG="--register-unsafely-without-email"
else
    EMAIL_FLAG="-m $EMAIL"
fi

APP_DIR="/var/www/capture-os"
APP_USER="www-data"

echo ""
info "åŸŸå: $DOMAIN"
info "åº”ç”¨ç›®å½•: $APP_DIR"
echo ""
read -p "ç¡®è®¤ä»¥ä¸Šä¿¡æ¯ï¼Ÿ(y/n): " CONFIRM
if [ "$CONFIRM" != "y" ] && [ "$CONFIRM" != "Y" ]; then
    echo "å·²å–æ¶ˆã€‚"
    exit 0
fi

# ============================================================
# ç¬¬ 1 æ­¥ï¼šç³»ç»Ÿæ›´æ–°
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 1 æ­¥ï¼šæ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
apt update && apt upgrade -y
ok "ç³»ç»Ÿå·²æ›´æ–°"

# ============================================================
# ç¬¬ 2 æ­¥ï¼šå®‰è£… Node.js 18
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 2 æ­¥ï¼šå®‰è£… Node.js..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if command -v node &> /dev/null; then
    NODE_VER=$(node -v)
    ok "Node.js å·²å®‰è£…: $NODE_VER"
else
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt install -y nodejs
    ok "Node.js $(node -v) å®‰è£…å®Œæˆ"
fi

# ============================================================
# ç¬¬ 3 æ­¥ï¼šå®‰è£… Nginx
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 3 æ­¥ï¼šå®‰è£… Nginx..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
apt install -y nginx
systemctl enable nginx
systemctl start nginx
ok "Nginx å·²å®‰è£…å¹¶å¯åŠ¨"

# ============================================================
# ç¬¬ 4 æ­¥ï¼šå®‰è£… PM2
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 4 æ­¥ï¼šå®‰è£… PM2 è¿›ç¨‹ç®¡ç†å™¨..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if command -v pm2 &> /dev/null; then
    ok "PM2 å·²å®‰è£…"
else
    npm install -g pm2
    ok "PM2 å®‰è£…å®Œæˆ"
fi

# ============================================================
# ç¬¬ 5 æ­¥ï¼šå®‰è£… Certbot (SSL)
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 5 æ­¥ï¼šå®‰è£… Certbot..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
apt install -y certbot python3-certbot-nginx
ok "Certbot å®‰è£…å®Œæˆ"

# ============================================================
# ç¬¬ 6 æ­¥ï¼šå®‰è£…æ„å»ºå·¥å…· (better-sqlite3 éœ€è¦)
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 6 æ­¥ï¼šå®‰è£…ç¼–è¯‘å·¥å…· (better-sqlite3 ä¾èµ–)..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
apt install -y build-essential python3
ok "ç¼–è¯‘å·¥å…·å·²å®‰è£…"

# ============================================================
# ç¬¬ 7 æ­¥ï¼šéƒ¨ç½²åº”ç”¨ä»£ç 
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 7 æ­¥ï¼šå‡†å¤‡åº”ç”¨ç›®å½•..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
mkdir -p $APP_DIR/data
if [ -f "$APP_DIR/server.js" ]; then
    ok "æ£€æµ‹åˆ°åº”ç”¨ä»£ç å·²å­˜åœ¨äº $APP_DIR"
else
    warn "åº”ç”¨ä»£ç å°šæœªä¸Šä¼ ï¼"
    warn "è¯·åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¸Šä¼ ä»£ç ï¼š"
    echo ""
    echo "  scp -r /path/to/capture-os/* root@ä½ çš„æœåŠ¡å™¨IP:$APP_DIR/"
    echo ""
    read -p "ä»£ç ä¸Šä¼ å®Œæˆåï¼ŒæŒ‰å›è½¦ç»§ç»­..." _WAIT
fi

# å®‰è£…ä¾èµ–
echo ""
info "å®‰è£… npm ä¾èµ–..."
cd $APP_DIR
npm install --production
ok "ä¾èµ–å®‰è£…å®Œæˆ"

# ============================================================
# ç¬¬ 8 æ­¥ï¼šæ›´æ–° .env æ–‡ä»¶ä¸­çš„ BASE_URL
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 8 æ­¥ï¼šæ›´æ–° .env é…ç½®..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -f "$APP_DIR/.env" ]; then
    # æ›¿æ¢ BASE_URL
    if grep -q "BASE_URL" "$APP_DIR/.env"; then
        sed -i "s|BASE_URL=.*|BASE_URL=https://$DOMAIN|g" "$APP_DIR/.env"
        ok "BASE_URL å·²æ›´æ–°ä¸º https://$DOMAIN"
    else
        echo "BASE_URL=https://$DOMAIN" >> "$APP_DIR/.env"
        ok "BASE_URL å·²æ·»åŠ : https://$DOMAIN"
    fi
else
    warn ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º"
fi

# ============================================================
# ç¬¬ 9 æ­¥ï¼šé…ç½® Nginx åå‘ä»£ç†
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 9 æ­¥ï¼šé…ç½® Nginx åå‘ä»£ç†..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

cat > /etc/nginx/sites-available/capture-os << NGINX_EOF
server {
    listen 80;
    server_name $DOMAIN;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;

        # è¶…æ—¶é…ç½®ï¼ˆAI å¤„ç†å¯èƒ½è¾ƒæ…¢ï¼‰
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
}
NGINX_EOF

# å¯ç”¨ç«™ç‚¹
ln -sf /etc/nginx/sites-available/capture-os /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default  # åˆ é™¤é»˜è®¤ç«™ç‚¹

# æµ‹è¯•é…ç½®
nginx -t || fail "Nginx é…ç½®æœ‰è¯¯ï¼"
systemctl reload nginx
ok "Nginx åå‘ä»£ç†å·²é…ç½®"

# ============================================================
# ç¬¬ 10 æ­¥ï¼šé…ç½®é˜²ç«å¢™
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 10 æ­¥ï¼šé…ç½®é˜²ç«å¢™..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ufw allow OpenSSH
ufw allow 'Nginx Full'
echo "y" | ufw enable
ok "é˜²ç«å¢™å·²å¯ç”¨ (SSH + HTTP + HTTPS)"

# ============================================================
# ç¬¬ 11 æ­¥ï¼šä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 11 æ­¥ï¼šå¯åŠ¨åº”ç”¨..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd $APP_DIR

# å¦‚æœå·²æœ‰è¿›ç¨‹å…ˆåœæ­¢
pm2 delete capture-os 2>/dev/null || true

pm2 start server.js --name capture-os --cwd $APP_DIR
pm2 save
pm2 startup systemd -u root --hp /root
ok "åº”ç”¨å·²é€šè¿‡ PM2 å¯åŠ¨"

# ============================================================
# ç¬¬ 12 æ­¥ï¼šé…ç½® SSL è¯ä¹¦
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 12 æ­¥ï¼šç”³è¯· SSL è¯ä¹¦..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
warn "è¯·ç¡®ä¿åŸŸå $DOMAIN çš„ DNS å·²æŒ‡å‘æ­¤æœåŠ¡å™¨ IPï¼"
read -p "DNS å·²é…ç½®å¥½ï¼Ÿ(y/n): " DNS_OK

if [ "$DNS_OK" = "y" ] || [ "$DNS_OK" = "Y" ]; then
    certbot --nginx -d $DOMAIN $EMAIL_FLAG --agree-tos --non-interactive || {
        warn "SSL è¯ä¹¦ç”³è¯·å¤±è´¥ï¼Œå¯èƒ½æ˜¯ DNS å°šæœªç”Ÿæ•ˆ"
        warn "ç¨åå¯æ‰‹åŠ¨è¿è¡Œ: sudo certbot --nginx -d $DOMAIN"
    }
    # è®¾ç½®è‡ªåŠ¨ç»­æœŸ
    systemctl enable certbot.timer
    ok "SSL è¯ä¹¦å·²é…ç½®"
else
    warn "è·³è¿‡ SSL é…ç½®ï¼Œè¯·ç¨åæ‰‹åŠ¨è¿è¡Œï¼š"
    echo "  sudo certbot --nginx -d $DOMAIN"
fi

# ============================================================
# ç¬¬ 13 æ­¥ï¼šè®¾ç½®è‡ªåŠ¨å¤‡ä»½
# ============================================================
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
info "ç¬¬ 13 æ­¥ï¼šè®¾ç½®æ¯æ—¥è‡ªåŠ¨å¤‡ä»½..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

mkdir -p /var/backups/capture-os

cat > /etc/cron.daily/capture-os-backup << 'BACKUP_EOF'
#!/bin/bash
# Capture OS æ¯æ—¥å¤‡ä»½è„šæœ¬
BACKUP_DIR="/var/backups/capture-os"
APP_DIR="/var/www/capture-os"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½æ•°æ®åº“å’Œç”¨æˆ·æ•°æ®
cp -f "$APP_DIR/data/capture-os.db" "$BACKUP_DIR/capture-os_$DATE.db" 2>/dev/null
cp -f "$APP_DIR/users.json" "$BACKUP_DIR/users_$DATE.json" 2>/dev/null
cp -f "$APP_DIR/.env" "$BACKUP_DIR/env_$DATE.bak" 2>/dev/null

# åªä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½
find "$BACKUP_DIR" -name "*.db" -mtime +30 -delete
find "$BACKUP_DIR" -name "*.json" -mtime +30 -delete
find "$BACKUP_DIR" -name "*.bak" -mtime +30 -delete
BACKUP_EOF

chmod +x /etc/cron.daily/capture-os-backup
ok "æ¯æ—¥è‡ªåŠ¨å¤‡ä»½å·²é…ç½® (ä¿ç•™ 30 å¤©)"

# ============================================================
#  å®Œæˆï¼
# ============================================================
echo ""
echo "========================================================"
echo -e "  ${GREEN}ğŸ‰ éƒ¨ç½²å®Œæˆï¼${NC}"
echo "========================================================"
echo ""
echo "  ğŸ“¡ æœåŠ¡åœ°å€: https://$DOMAIN"
echo "  ğŸ“ åº”ç”¨ç›®å½•: $APP_DIR"
echo "  ğŸ“Š PM2 çŠ¶æ€: pm2 status"
echo "  ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: pm2 logs capture-os"
echo "  ğŸ”„ é‡å¯æœåŠ¡: pm2 restart capture-os"
echo "  ğŸ’¾ å¤‡ä»½ç›®å½•: /var/backups/capture-os"
echo ""
echo "  âš ï¸  é‡è¦æé†’ï¼š"
echo "  1. å» Notion Developers æ›´æ–° OAuth å›è°ƒåœ°å€ä¸º:"
echo "     https://$DOMAIN/callback"
echo "  2. æ›´æ–° iPhone å¿«æ·æŒ‡ä»¤ä¸­çš„ API åœ°å€ä¸º:"
echo "     https://$DOMAIN/capture"
echo ""
echo "========================================================"
